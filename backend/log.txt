============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0
rootdir: /root/cautious-happiness/backend
plugins: asyncio-1.3.0, langsmith-0.6.2, anyio-4.12.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 4 items

tests/test_guardrails.py ...Traceback (most recent call last):
  File "/root/cautious-happiness/backend/app/engine.py", line 544, in run_analysis
    result.category = category
    ^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/dist-packages/pydantic/main.py", line 1032, in __setattr__
    elif (setattr_handler := self._setattr_handler(name, value)) is not None:
                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/dist-packages/pydantic/main.py", line 1079, in _setattr_handler
    raise ValueError(f'"{cls.__name__}" object has no field "{name}"')
ValueError: "ForecastResult" object has no field "category"
>>> STARTING RUN_ANALYSIS
Market Classified as: Economics
MOCK GEN ARGS: ('Will inflation rise?', [], []) KWARGS: {'category': 'Economics'}
Audit Log Failed: (sqlite3.OperationalError) no such table: audit_logs
[SQL: SELECT audit_logs.id AS audit_logs_id, audit_logs.timestamp AS audit_logs_timestamp, audit_logs.event_type AS audit_logs_event_type, audit_logs.payload AS audit_logs_payload, audit_logs.user_id AS audit_logs_user_id, audit_logs.previous_hash AS audit_logs_previous_hash, audit_logs.record_hash AS audit_logs_record_hash 
FROM audit_logs ORDER BY audit_logs.id DESC
 LIMIT ? OFFSET ?]
[parameters: (1, 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
MOCK CRITIQUE ARGS: ('Will inflation rise?', [], 0.6000000000000001, 'Inflation is soaring.\n\n[Guardrail Alert]: Probability adjusted due to failed verification.')
DEBUG: optimal_allocation returning: (283.34040000000005, 650.7400000000001, 0.43541260718566555)
>>> FINISHED RUN_ANALYSIS. Forecast: 0.0
ERROR IN RESULT: unknown_error
REASONING Snippet: "ForecastResult" object has no field "category"
F

=================================== FAILURES ===================================
_____________ test_integration_run_analysis_with_verification_fail _____________

    @pytest.mark.asyncio
    async def test_integration_run_analysis_with_verification_fail():
        """
        Test the full pipeline adjustment on verification failure.
        """
        with patch('app.engine.DDGS'):
            engine = ForecasterCriticEngine()
    
        # Mock methods to isolate guardrail logic
        engine.search_market_news = AsyncMock(return_value=[])
        engine.aggregator.fetch_all = AsyncMock(return_value=[])
        engine.alt_data_client.get_signals_for_market = MagicMock(return_value=[])
        engine.social_aggregator.fetch_all = AsyncMock(return_value=[])
        engine.classify_market = AsyncMock(return_value="Economics")
        engine.sentiment_detector.detect_hype_and_manipulation = MagicMock(return_value={
            "hype_score": 0.0,
            "sentiment_score": 0.5,
            "summary": "Neutral"
        })
        engine.risk_engine.check_portfolio_risk = MagicMock(return_value=[])
    
        async def mock_gen(*args, **kwargs):
            print(f"MOCK GEN ARGS: {args} KWARGS: {kwargs}")
            return 0.8, "Inflation is soaring."
        engine.generate_forecast_with_reasoning = mock_gen
    
        async def mock_critique(*args, **kwargs):
            print(f"MOCK CRITIQUE ARGS: {args}")
            # Adjust index if self is passed
            p = args[2]
            return "Critique", p
        engine.critique_forecast = mock_critique
    
        engine.extract_claims = AsyncMock(return_value=["Inflation soaring"])
        engine.verify_claims = AsyncMock(return_value=("Report: FALSE", False))
    
        print(">>> STARTING RUN_ANALYSIS")
        result = await engine.run_analysis("Will inflation rise?")
        print(f">>> FINISHED RUN_ANALYSIS. Forecast: {result.initial_forecast}")
    
        if result.error:
             print(f"ERROR IN RESULT: {result.error}")
             print(f"REASONING Snippet: {result.reasoning[:200]}")
    
        # Initial was 0.8. Failed verification should penalize it.
        # Logic: max(0.5, 0.8 - 0.2) = 0.6
>       assert abs(result.initial_forecast - 0.6) < 1e-9
E       assert 0.6 < 1e-09
E        +  where 0.6 = abs((0.0 - 0.6))
E        +    where 0.0 = ForecastResult(search_query='Will inflation rise?', news_summary=[], initial_forecast=0.0, critique='Error', adjusted_...gnals=[], reasoning='"ForecastResult" object has no field "category"', verification_report=None, error='unknown_error').initial_forecast

tests/test_guardrails.py:132: AssertionError
=============================== warnings summary ===============================
app/models.py:90
  /root/cautious-happiness/backend/app/models.py:90: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ChatMessage(BaseModel):

app/models.py:115
  /root/cautious-happiness/backend/app/models.py:115: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class HistoricalMarketResponse(BaseModel):

app/models.py:131
  /root/cautious-happiness/backend/app/models.py:131: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class BacktestResultResponse(BaseModel):

app/models.py:172
  /root/cautious-happiness/backend/app/models.py:172: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DrawdownLimitResponse(BaseModel):

app/models.py:182
  /root/cautious-happiness/backend/app/models.py:182: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DailyStatsResponse(BaseModel):

app/models.py:218
  /root/cautious-happiness/backend/app/models.py:218: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AlgoOrderResponse(BaseModel):

app/models.py:242
  /root/cautious-happiness/backend/app/models.py:242: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class RiskParametersResponse(BaseModel):

tests/test_guardrails.py::test_integration_run_analysis_with_verification_fail
  /root/cautious-happiness/backend/app/database.py:13: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

tests/test_guardrails.py::test_integration_run_analysis_with_verification_fail
  /root/cautious-happiness/backend/app/database_users.py:12: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    BaseUsers = declarative_base()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_guardrails.py::test_integration_run_analysis_with_verification_fail
=================== 1 failed, 3 passed, 9 warnings in 5.46s ====================
